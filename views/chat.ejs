<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì±„íŒ… í”„ë¡œê·¸ë¨</title>

    <!-- socket.io cdn -->
    <script
      src="https://cdn.socket.io/4.5.3/socket.io.min.js"
      integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="../static/css/chat.css" />
  </head>
  <body>
    <h1>Socket.io</h1>

    <!-- [ì‹¤ìŠµ44-2] ì±„íŒ…ì°½ ì…ì¥ ë¬¸êµ¬ ì•ˆë‚´ socket.id -> nickname -->
    <div class="entry-box">
      <input
        type="text"
        id="nickname"
        placeholder="ë‹‰ë„¤ì„"
        autofocus
        onkeydown="if(event.keyCode==13) javascript: entry();"
      />
      <button type="button" id="entryBtn" onclick="entry()">ì…ì¥</button>
    </div>
    <div class="chatbox d-none">
      <div id="chatlist" class="chatlist">
        <!-- [ì‹¤ìŠµ43] ì„ì‹œ ë°ì´í„° -->
        <!-- <div class="mychat">
          <div>ì•ˆë…•</div>
        </div>
        <div class="otherchat">
          <div>ì‘ ì•ˆë…•</div>
        </div>
        <div class="notice">XXê°€ ì…ì¥í–ˆìŠµë‹ˆë‹¤.</div> -->
      </div>
      <select id="nicklist">
        <!-- <option value="all">ì „ì²´</option>
        <option value="socket.id1">nick1</option>
        <option value="socket.id2">nick2</option> -->
      </select>
      ì—ê²Œ
      <input
        type="text"
        id="message"
        onkeydown="if(event.keyCode==13) javascript: send();"
      />
      <button type="button" id="sendBtn" onclick="send()">ì „ì†¡</button>
    </div>

    <!-- <button onclick="sayHello()">hello</button>
    <button onclick="sayStudy()">study</button>
    <button onclick="sayBye()">bye</button>
    <p id="from-server"></p> -->

    <script>
      let socket = io.connect(); // socket ì‚¬ìš©ì„ ìœ„í•œ ê°ì²´ ìƒì„±
      let myNick; // ë‚´ ë‹‰ë„¤ì„ ì„¤ì •

      socket.on("connect", () => {
        console.log("ğŸ’¥Server Socket ConnectedğŸ’¥ >>", socket.id);
      });

      //   [ì‹¤ìŠµ44] ì±„íŒ…ì°½ ì…ì¥ ì•ˆë‚´ ë¬¸êµ¬
      // notice ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ì„œ ê³µì§€ ë¬¸êµ¬ë¥¼ ì¶œë ¥
      socket.on("notice", (msg) => {
        console.log("socket on notice >> ", msg);
        document
          .querySelector("#chatlist")
          .insertAdjacentHTML("beforeend", `<div class="notice">${msg}</div>`);
      });

      // [ì‹¤ìŠµ44-2] ì±„íŒ…ì°½ ì…ì¥ ì•ˆë‚´ë¬¸êµ¬ socket.id -> nickname
      function entry() {
        console.log(document.querySelector("#nickname").value);
        if (document.querySelector("#nickname").value == "") {
          alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”");
          return;
        }

        socket.emit("setNick", document.querySelector("#nickname").value);
        // ì‹¤ìŠµ44 ì‚´ë ¤ì„œ ì¶”ê°€ë˜ê²Œë”
      }

      socket.on("entrySuccess", (nick) => {
        myNick = nick;

        // ì…ë ¥ì°½ ë¹„í™œì„±í™”
        document.querySelector("#nickname").disabled = true;
        // [ì…ì¥]ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelector(".entry-box > button").disabled = true;
        // ì±„íŒ…ë°•ìŠ¤ë¥¼ ë³´ì—¬ì¤Œ
        document.querySelector(".chatbox").classList.remove("d-none");
      });

      socket.on("error", (data) => {
        console.log("error", data);
        alert(data);
      });

      // [ì‹¤ìŠµ45] ì±„íŒ…ì°½ ë©”ì„¸ì§€ ì „ì†¡ Step1
      // 'send' ì´ë²¤íŠ¸ ì „ì†¡í•˜ê¸°
      function send() {
        data = {
          myNick: myNick, // 'entrySuccess' ì´ë²¤íŠ¸ì—ì„œ ì…ì¥ ì„±ê³µì‹œ ì„¤ì •í•˜ëŠ” ë‚´ ë‹‰ë„¤ì„
          dm: document.querySelector("#nicklist").value, // í˜„ì¬ ì„ íƒëœ select íƒœê·¸ì˜ optionê°’
          msg: document.querySelector("#message").value,
        };

        if (document.querySelector("#message").value == "") {
          alert("ì±„íŒ…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”");
          return;
        }
        socket.emit("send", data);
      }

      // [ì‹¤ìŠµ45] ì±„íŒ…ì°½ ë©”ì„¸ì§€ ì „ì†¡ Step2
      // 'newMessage' ì´ë²¤íŠ¸ë¥¼ ì „ë‹¬ë°›ê¸° { ë‹‰ë„¤ì„, ë©”ì„¸ì§€ë‚´ìš© }
      // data
      socket.on("newMessage", (data) => {
        console.log("socket on newMessage >> ", data);
        // ìƒì„±í•´ì•¼í•  ì±„íŒ… htmlêµ¬ì¡°
        //    <div class="mychat">
        //       <div>ì•ˆë…•</div>
        //     </div>
        //     <div class="otherchat">
        //       <div>ì‘ ì•ˆë…•</div>
        //     </div>
        let chatList = document.querySelector("#chatlist"); // #chatlist ì„ íƒ
        let div = document.createElement("div"); // .mychat or .otherchat ìƒì„±
        // <div></div>
        let divChat = document.createElement("div"); // ê°€ì¥ ì•ˆìª½ div (ë©”ì„¸ì§€ ë°•ìŠ¤) ìƒì„±
        // <div></div>
        let divNick = document.createElement("p");

        // ìƒˆ ë©”ì„¸ì§€(data => { nick: 'a', msg: 'hello' })ê°€ ë„ì°© í–ˆëŠ”ë°
        // myNickì— ì €ì¥ëœ í˜„ì¬ ë‚´ ë‹‰ë„¤ì„ê³¼
        // ìƒˆ ë©”ì„¸ì§€(data)ì˜ nickì´ ê°™ë‹¤ë©´, ë‚´ê°€ ë³´ë‚¸ ì±„íŒ…
        // ìƒˆ ë©”ì„¸ì§€(data)ì˜ nickì´ ë‹¤ë¥´ë©´, ìƒëŒ€ë°©ì´ ë³´ë‚¸ ì±„íŒ…

        if (myNick == data.nick) {
          div.classList.add("mychat"); // <div class="mychat"></div>
        } else {
          div.classList.add("otherchat"); // <div class="otherchat"></div>
        }

        // [ì‹¤ìŠµ46] DM ê¸°ëŠ¥ ì¶”ê°€
        console.log("send data check >> ", data);
        // ì „ì²´ë¡œ ë³´ëƒˆì„ ë•Œ: {nick: 'ã…', msg: 'ã…'}
        // dmìœ¼ë¡œ ë³´ëƒˆì„ ë•Œ: {nick: 'ã…', msg: 'ã…', dm: '(ì†ë‹¥ì†ë‹¥)'}
        if (data.dm) {
          div.classList.add("secret-chat");
          divChat.textContent = data.dm; // (ì†ë‹¥ì†ë‹¥) ê¸€ì ì¶”ê°€
        }
        divNick.textContent = data.nick; // <p>nick</p>
        // divChat.textContent = data.msg; // <div>msg</div>
        divChat.textContent += data.msg; // <div>(ì†ë‹¥ì†ë‹¥) nick : msg</div>

        div.appendChild(divNick);

        div.appendChild(divChat);

        chatList.appendChild(div);

        // ìŠ¤í¬ë¡¤í•˜ë‹¨ê³ ì •
        chatList.scrollTop = chatList.scrollHeight;

        clearInput();
      });

      // [ì‹¤ìŠµ46] DMê¸°ëŠ¥ ì¶”ê°€
      socket.on("updateNicks", (nickArray) => {
        console.log("socket on updateNicks >> ", nickArray);

        // ë¯¸ì…˜
        // ìœ ì €ëª©ë¡ í•˜ë‚˜í•˜ë‚˜ë¥¼ optioníƒœê·¸ë¡œ ë§Œë“¤ì–´ì„œ selectì— ì¶”ê°€
        // select íƒœê·¸ ë‚´ë¶€ì— ì¶”ê°€ë˜ì–´ì•¼ í•  ì½”ë“œ í˜•ì‹
        // <option value="all">ì „ì²´</option>
        // <option value="socket.id1">nick1</option>
        // <option value="socket.id2">nick2</option>
        let options = `<option value='all'>ì „ì²´</option>`; // ëª¨ë“  option íƒœê·¸ë“¤

        // 1. ë°˜ë³µë¬¸ ì‚¬ìš©í•´ì„œ optioníƒœê·¸ í•˜ë‚˜í•˜ë‚˜ ì™„ì„±
        for (const socketid in nickArray) {
          console.log(`${socketid}: ${nickArray[socketid]}`); // socket.id: nickname
          console.log(
            `<option value='${socketid}'>${nickArray[socketid]}</option>`
          );
          options =
            options +
            `<option value='${socketid}'>${nickArray[socketid]}</option>`; // x = x + 1
          // options += `<option value='${socketid}'>${nickArray[socketid]}</option>`; // x += 1
        }

        console.log(options);
        // 2. select íƒœê·¸ì— option íƒœê·¸ë“¤ì„ ì¶”ê°€
        // selectíƒœê·¸.innerHTML = options;
        let select = document.getElementById("nicklist");
        select.innerHTML = options;
      });

      function clearInput() {
        const txtmsg = document.getElementById("message");
        txtmsg.value = "";
      }

      //   ì‹¤ìŠµ42
      //   function setMsg(obj) {
      //     console.log("setMsg obj >> ", obj);
      //     document.querySelector(
      //       "#from-server"
      //     ).textContent = `${obj.who} : ${obj.msg}`;
      //   }

      //   function sayHello() {
      //     socket.emit("hello", { who: "client", msg: "hello" }); // emitìœ¼ë¡œ ì„œë²„ì— dataë¥¼ ë³´ë‚´ì¤Œ
      //     socket.on("helloKr", (data) => {
      //       // onìœ¼ë¡œ ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ dataë¥¼ textContentë¡œ ì¶œë ¥í•¨
      //       //   console.log("socket on helloKr >> ", data);
      //       //   document.querySelector(
      //       //   "#from-server"
      //       // ).textContent = `${data.who} : ${data.msg}`; // ê¸´ ì½”ë“œê°€ ë°˜ë³µì ìœ¼ë¡œ ë“¤ì–´ê°€ì„œ í•¨ìˆ˜ë¡œ ë”°ë¡œ ë¹¼ì£¼ëŠ” ë¦¬íŒ©í† ë§ ì§„í–‰
      //       setMsg(data);
      //     });
      //   }

      //   function sayStudy() {
      //     socket.emit("study", { who: "client", msg: "study" }); // emitìœ¼ë¡œ ì„œë²„ì— dataë¥¼ ë³´ë‚´ì¤Œ
      //     socket.on("studyKr", (data) => {
      //       // onìœ¼ë¡œ ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ dataë¥¼ textContentë¡œ ì¶œë ¥í•¨
      //       //   console.log("socket on studyKr >> ", data);
      //       setMsg(data);
      //     });
      //   }

      //   function sayBye() {
      //     socket.emit("bye", { who: "client", msg: "bye" }); // emitìœ¼ë¡œ ì„œë²„ì— dataë¥¼ ë³´ë‚´ì¤Œ
      //     socket.on("byeKr", (data) => {
      //       // onìœ¼ë¡œ ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ dataë¥¼ textContentë¡œ ì¶œë ¥í•¨
      //       //   console.log("socket on byeKr >> ", data);
      //       setMsg(data);
      //     });
      //   }
    </script>
  </body>
</html>
